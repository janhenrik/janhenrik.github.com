<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Maven release med Ruby</title>
   <meta name="author" content="Jan Henrik Gundelsby" />
   <meta name="readability-verification" content="QCzSs992GxmRYRKVpPeZ6LE2tS8aYKxsSSQKV8YM"/>

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />

   <!-- Typekit -->
   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

  <!-- Google Analytics -->
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35123816-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
  <!-- Google Analytics end -->
</head>
<body>

<div class="site">
  <div class="title">
    <img align="right" src="http://s.gravatar.com/avatar/d8f2304e4b47c512f821f2bcc241616a?s=80"/>
    <a href="/">Jan Henrik Gundelsby</a>
    <a class="extra" href="/">home</a>
  </div>
  
  <div id="post">
<h1>Maven release med Ruby</h1>

<p>Mange av oss bruker <a href="http://maven.apache.org">Maven</a> for å bygge, versjonere og holde styr på avhengigheter både til eksterne biblioteker og egne. Maven har også en <a href="http://maven.apache.org/plugins/maven-release-plugin/">release plugin</a> som er Mavens forsøk på å standardisere en release-prosess, og det gjør den i tre faser over flere steg.</p>

<ul>
<li>Prepare a release, <a href="http://maven.apache.org/plugins/maven-release-plugin/examples/prepare-release.html">mvn release:prepare</a></li>
<li>Perform a release, <a href="http://maven.apache.org/plugins/maven-release-plugin/examples/perform-release.html">mvn release:perform</a></li>
<li>Rollback a release, <a href="http://maven.apache.org/plugins/maven-release-plugin/rollback-mojo.html">mvn release:rollback</a></li>
</ul>


<p>Innføring av denne i vårt prosjekt bød på flere problemer. Prosjektet vårt har en del andre krav enn det Maven release-pluginen forventer. Vi bruker git istedet for subversion, vi har standardiserte måter å versjonere komponenter på, slik at neste versjon alltid kan utledes av forrige. I tillegg synes vi release-prosessen til Maven brukte evigheter på å analysere, bygge og starte opp. Derfor forsøkte vi å skrive dette selv, med utgangspunkt i Maven sin dokumentasjon. Prosjektet hadde kompetanse på Ruby, og vi følte dette var et godt utgangspunkt for å parse XML og enkelt kunne kjøre git-kommandoer. Følgende er vår løsning på stegene beskrevet i Maven sin release-prosess:</p>

<h5>mvn release:prepare: 1. Check that there are no uncommitted changes in the sources</h5>

<p>Dette er lett å implementere. En oneliner med git.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">clean_wd?</span>
  <span class="sb">`git status --porcelain -- . | wc -l`</span><span class="o">.</span><span class="n">strip</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span>
<span class="k">end</span>
</code></pre></div>


<p><br/></p>

<h5>mvn release:prepare: 2. Check that there are no SNAPSHOT dependencies</h5>

<p>Vi bruker <a href="http://nokogiri.org">Nokogiri</a> for å parse XML, Ruby trenger ikke å kjenne til Mavens dependency-tre for de enkle tingene release-prossen skal gjøre. I og med at det er veldefinerte steder i POM-filene SNAPSHOT-dependencies kan være, var dette trivielt.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">snapshot_dependencies?</span>
   <span class="nb">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;dependency&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dep</span><span class="o">|</span>
     <span class="n">dep</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">ver</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">ver</span><span class="o">.</span><span class="n">content</span> <span class="o">=~</span> <span class="sr">/SNAPSHOT/i</span>
          <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Prosjektet </span><span class="si">#{</span><span class="n">artifactId</span><span class="si">}</span><span class="s2"> har SNAPSHOT avhengigheter</span>
<span class="s2">              i artifact: </span><span class="si">#{</span><span class="n">artifactIdForDep</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">ver</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
   <span class="k">end</span>
   <span class="c1"># Tilsvarende for &lt;properties&gt; og project &gt; parent &gt; version  # for super-pom</span>
</code></pre></div>


<p><br/></p>

<h5>mvn release:prepare: 3. Change the version in the POMs from x-SNAPSHOT to a new version (you will be prompted for the versions to use)</h5>

<p>Vi har veldefinerte regler for bumping av versjonsnummer. Alltid minor-versjon, evt. patchversjon dersom det er spesifisert på kommandolinjen inn til scriptet.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">neste_snapshot</span> <span class="n">release_version</span>
  <span class="n">versionsnummer</span> <span class="o">=</span> <span class="n">release_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
  <span class="n">major</span> <span class="o">=</span> <span class="n">versionsnummer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">to_i</span>
  <span class="n">minor</span> <span class="o">=</span> <span class="n">versionsnummer</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">to_i</span>
  <span class="n">patch</span> <span class="o">=</span> <span class="n">versionsnummer</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="n">to_i</span>
  <span class="k">if</span> <span class="n">patch</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">minor</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.0&quot;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">minor</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">patch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>


<p><br/></p>

<h5>mvn release:prepare: 4. Transform the SCM information in the POM to include the final destination of the tag</h5>

<p>Et unødvendig steg, for å være helt ærlig skjønner vi ikke hva som menes. Dersom vi ikke forstår det, bør vi mest sannsynlig heller ikke implementere noe.</p>

<h5>mvn release:prepare: 5. Run the project tests against the modified POMs to confirm everything is in working order</h5>

<p>Dette er eneste gangen vi bygger prosjektet og sjekker at alle tester kjører.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">mvn_success</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mvn -U clean package &gt;&gt; /tmp/mvn_build&quot;</span><span class="p">)</span>
<span class="k">unless</span> <span class="n">mvn_success</span>
    <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Build failure&quot;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>


<p><br/></p>

<h5>mvn release:prepare: 6. Commit the modified POMs</h5>

<p>Commit av release-versjonen til git.</p>

<div class="highlight"><pre><code class="ruby"> <span class="sb">`git commit pom.xml */pom.xml -m &quot;[release.rb] Release ny versjon av</span>
<span class="sb">                    </span><span class="si">#{</span><span class="n">super_pom</span><span class="o">.</span><span class="n">artifactId</span><span class="si">}</span><span class="sb">-</span><span class="si">#{</span><span class="n">release_version</span><span class="si">}</span><span class="sb">&quot;`</span>
</code></pre></div>


<p><br/></p>

<h5>mvn release:prepare: 7. Tag the code in the SCM with a version name (this will be prompted for)</h5>

<p>Tag av kode for release-versjonen.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;git tag -f </span><span class="si">#{</span><span class="n">super_pom</span><span class="o">.</span><span class="n">artifactId</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">release_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">raise</span><span class="p">(</span><span class="s2">&quot;Could not create tag.&quot;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>


<p><br/></p>

<h5>mvn release:prepare: 8. Bump the version in the POMs to a new value y-SNAPSHOT (these values will also be prompted for)</h5>

<p>Igjen er det en veldefinert måte å bumpe versjonsnummer på, denne gangen til neste utviklingsversjon.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">neste_release</span> <span class="n">version</span>
  <span class="n">versionsnummer</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
  <span class="n">major</span> <span class="o">=</span> <span class="n">versionsnummer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">to_i</span>
  <span class="n">minor</span> <span class="o">=</span> <span class="n">versionsnummer</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">to_i</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">major</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">minor</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.0-SNAPSHOT&quot;</span>
<span class="k">end</span>
</code></pre></div>


<p><br/></p>

<h5>mvn release:prepare: 9. Commit the modified POMs</h5>

<p>En commit av neste utviklingsversjon, og her kommer til slutt også push til sentralt repo.</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">puts</span> <span class="s2">&quot;Sjekker inn ny utviklingsversjon&quot;</span>
  <span class="sb">`git commit pom.xml */pom.xml -m &quot;[release.rb] Ny utviklingsversjon av </span>
<span class="sb">       </span><span class="si">#{</span><span class="n">super_pom</span><span class="o">.</span><span class="n">artifactId</span><span class="si">}</span><span class="sb">-</span><span class="si">#{</span><span class="n">snapshot_version</span><span class="si">}</span><span class="sb">&quot;`</span>
<span class="nb">puts</span> <span class="s2">&quot;Pusher til sentralt git repository.&quot;</span>
<span class="sb">`git push --tags &amp;&amp; git push origin </span><span class="si">#{</span><span class="n">current_branch</span><span class="si">}</span><span class="sb">`</span>
</code></pre></div>


<p><br/></p>

<p>Ved å pushe til sentralt repo helt til slutt får vi en atomisk operasjon, slik at evt. rollback blir enkelt.</p>

<h5>mvn release:release: 1. Checkout from an SCM URL with optional tag</h5>

<p>Nå som prepare-steget er ferdig kan releasen-fasen starte. Maven release-pluginen laster ned koden igjen fra tag og bygger. Dette er ikke nødvendig hvis du har distribuert versjonskontroll, da kan du eventuelt få konflikt ved push til master til slutt, men selve bygget blir likt det vi gjorde i steget over. Derfor bygger vi ikke igjen.</p>

<h5>mvn release:release: 2. Run the predefined Maven goals to release the project (by default, deploy site-deploy)</h5>

<p>Vår release-prossess laster opp til artifactory. Dersom denne feiler er det viktig at det gjøres igjen, da releaset kode er pushet til master. Derfor har vi også parametrisert scriptet, slik at denne operasjonen kan gjøres uavhengig av "prepare-steget".</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">printf</span> <span class="s2">&quot;Laster opp </span><span class="si">#{</span><span class="n">local_file</span><span class="si">}</span><span class="s2"> til </span><span class="si">#{</span><span class="n">rest_of_path</span><span class="si">}</span><span class="s2">...&quot;</span>
<span class="k">begin</span>
  <span class="n">res</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">local_file</span><span class="p">))</span>
  <span class="k">unless</span> <span class="n">res</span><span class="o">.</span><span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">code</span> <span class="o">&lt;</span> <span class="mi">300</span>
    <span class="k">raise</span> <span class="s2">&quot;Opplasting til Artifactory svarte ikke med HTTP OK, </span>
<span class="s2">       feilmelding var: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
  <span class="nb">puts</span> <span class="s2">&quot;Opplasting vellykket! Status: </span><span class="si">#{</span><span class="n">res</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</code></pre></div>


<p><br/></p>

<h5>mvn release:rollback</h5>

<p>Ved feil før eller under push til sentralt git-repo, må vi resette lokal historie i git. Det blir vårt rollback-steg og utføres manuelt.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">origin</span><span class="o">/</span><span class="no">HEAD</span>
</code></pre></div>


<p><br/></p>

<h1>Konklusjon</h1>

<p>Vi bruker Maven kun til bygg, versjonering og avhengigheter. Der fungerer det bra.</p>

<p>Vårt script for release er på ~200 linjer Ruby-kode, og langt over dobbelt så raskt som Maven release-plugin og inneholder kun det vi forstår og våre egne forretningsregler for versjonering etc. Koden er enkel å forstå og endre på. Slike prosesser er bedre egnet for script enn Javakode og blir mer synlig på denne måten.</p>

</div>

  
  <div class="footer">
    <div class="contact">
      <p>
        Jan Henrik Gundelsby<br />
        janhenrik@gundelsby.com
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="http://github.com/janhenrik/">github.com/janhenrik</a><br />
        <a href="http://twitter.com/janhenrik/">twitter.com/janhenrik</a><br />
      </p>
    </div>
    <div class="rss">
      <a href="http://gundelsby.com/atom.xml">
        <img src="/images/rss.png" alt="Subscribe to RSS Feed" />
      </a>
    </div>
  </div>
</div>
</body>
</html>
